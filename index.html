<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Builder - Market Research Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .game-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #4CAF50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .entry-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .form-button:hover {
            transform: translateY(-2px);
        }

        .form-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .lobby-screen {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .countdown-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .countdown-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #e1e5e9;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            border-radius: 6px;
            transition: width 0.1s linear;
        }

        .players-list {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .player-item {
            display: inline-block;
            background: white;
            margin: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #e1e5e9;
        }

        .player-item.current-user {
            border-color: #28a745;
            background: #f8fff8;
        }

        .game-stage {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .game-stage.active {
            display: block;
        }

        .stage-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .stage-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stage-description {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .product-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .product-option {
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .product-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .product-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            padding: 5px 0;
            color: #555;
        }

        .feature-list li:before {
            content: "‚úì ";
            color: #28a745;
            font-weight: bold;
        }

        .building-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin: 20px 0;
        }

        .feature-pool {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .feature-tile {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: grab;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .feature-tile:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .feature-tile:active {
            cursor: grabbing;
        }

        .player-board {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            min-height: 200px;
        }

        .board-slot {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #999;
            transition: all 0.3s;
        }

        .board-slot.filled {
            border: 2px solid #28a745;
            background: #f8fff8;
            color: #333;
        }

        .board-slot.can-drop {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .board-slot.steal-target {
            border-color: #667eea !important;
            background: #f0f4ff !important;
            transform: scale(1.02);
        }

        .other-players {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .other-player {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .other-player:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .other-player.has-features {
            border-color: #28a745;
            background: #f8fff8;
        }

        .other-player.has-features:hover {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .other-player-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
            min-height: 60px;
        }

        .feature-slot {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .feature-slot.filled {
            border: 2px solid #28a745;
            background: #f8fff8;
            color: #333;
            cursor: grab;
            font-weight: 500;
            user-select: none;
        }

        .feature-slot.filled:active {
            cursor: grabbing;
        }

        .feature-slot.filled:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .feature-slot.filled.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .feature-slot.empty {
            color: #999;
            font-style: italic;
        }

        .steal-hint {
            font-size: 0.7rem;
            color: #667eea;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .other-player.has-features:hover .steal-hint {
            opacity: 1;
        }

        .results-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 5px solid #ccc;
        }

        .leaderboard-item.winner {
            border-left-color: #ffd700;
            background: #fff8dc;
        }

        .leaderboard-item.second {
            border-left-color: #c0c0c0;
        }

        .leaderboard-item.third {
            border-left-color: #cd7f32;
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            color: #ffd700;
            font-size: 1.2rem;
        }

        .star.empty {
            color: #ddd;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .building-area {
                grid-template-columns: 1fr;
            }
            
            .product-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status connected">üü¢ Connected</div>
    
    <div id="root">
        <div class="container">
            <div class="game-header">
                <h1 class="game-title">üèóÔ∏è Product Builder</h1>
                <p class="game-subtitle">Market Research Through Competitive Building</p>
            </div>
            
            <!-- Entry Form (Default View) -->
            <div id="entryView" class="entry-form">
                <h2 style="text-align: center; margin-bottom: 20px;">Welcome!</h2>
                
                <div id="urlInfo" style="display: none; background: rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 0.9em;"></div>
                
                <input type="text" id="playerNameInput" class="form-input" placeholder="Enter your name" autocomplete="off">
                
                <button id="joinGameBtn" class="form-button">Join Game</button>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <div style="margin-top: 15px; text-align: center; color: #666; font-size: 0.9em;">
                    Enter your name to join the next available game
                </div>
            </div>

            <!-- Lobby View -->
            <div id="lobbyView" class="lobby-screen hidden">
                <h2 style="font-size: 2em; margin-bottom: 15px;">üéÆ Game Lobby</h2>
                <p id="lobbyStatus" style="font-size: 1.2em; color: #666;">
                    üïê Waiting for game to start...
                </p>
                <div id="lobbyProgress" class="progress-bar-container" style="margin-top: 20px;">
                    <div class="progress-bar" style="width: 0%;"></div>
                </div>
                
                <div class="players-list">
                    <h3 style="margin-bottom: 20px;">Players in Lobby</h3>
                    <div id="playersContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <!-- Players will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Conjoint Stage -->
            <div id="conjointView" class="game-stage">
                <div class="stage-header">
                    <h2 class="stage-title">Stage 1: Product Preference</h2>
                    <p class="stage-description">Choose which product you would be most likely to buy</p>
                    <div id="conjointTimer" class="timer">Time remaining: 30s</div>
                </div>

                <div id="productOptions" class="product-options">
                    <!-- Product options will be populated here -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button id="submitChoiceBtn" class="form-button" style="max-width: 300px;" disabled>Submit Choice</button>
                </div>
            </div>

            <!-- Building Stage -->
            <div id="buildingView" class="game-stage">
                <div class="stage-header">
                    <h2 class="stage-title">Stage 2: Product Building</h2>
                    <p class="stage-description">Build your ideal product by dragging features to your board</p>
                    <div id="buildingTimer" class="timer">Time remaining: 60s</div>
                </div>

                <div class="building-area">
                    <div class="feature-pool">
                        <h3>Available Features</h3>
                        <div id="featuresGrid" class="features-grid">
                            <!-- Available features will be populated here -->
                        </div>
                    </div>

                    <div>
                        <div class="player-board">
                            <h3>Your Product Board</h3>
                            <div id="playerBoard" class="board-grid">
                                <!-- Player board slots will be populated here -->
                            </div>
                        </div>
                        
                        <div class="other-players">
                            <div id="otherPlayersContainer">
                                <!-- Other players will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results View -->
            <div id="resultsView" class="results-container hidden">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 15px;">üèÜ Game Complete!</h2>
                    <p style="font-size: 1.2em; color: #666;">Final Results</p>
                </div>

                <div class="leaderboard">
                    <h3 style="text-align: center; margin-bottom: 30px;">Leaderboard</h3>
                    <div id="leaderboardContainer">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>

                <div style="text-align: center;">
                    <button id="returnBtn" class="form-button" style="max-width: 300px;">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/.netlify/functions/product-api';
        
        // Game state
        let gameState = 'entry';
        let gameId = null;
        let playerId = null;
        let playerName = '';
        let panelId = '';
        let returnUrl = '';
        let gameData = null;
        let currentPlayer = null;
        let updateInterval = null;
        let connectionStatus = 'connected';
        let selectedOption = null;

        // DOM Elements
        const elements = {
            entryView: () => document.getElementById('entryView'),
            lobbyView: () => document.getElementById('lobbyView'),
            conjointView: () => document.getElementById('conjointView'),
            buildingView: () => document.getElementById('buildingView'),
            resultsView: () => document.getElementById('resultsView'),
            playerNameInput: () => document.getElementById('playerNameInput'),
            joinGameBtn: () => document.getElementById('joinGameBtn'),
            errorMessage: () => document.getElementById('errorMessage'),
            submitChoiceBtn: () => document.getElementById('submitChoiceBtn'),
            returnBtn: () => document.getElementById('returnBtn')
        };

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing game...');
            initializeGame();
        });

        function initializeGame() {
            console.log('Initializing game...');
            
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            panelId = urlParams.get('panel') || urlParams.get('panelId') || '';
            returnUrl = urlParams.get('return') || urlParams.get('returnUrl') || '';
            const autoStartParam = urlParams.get('autostart');
            
            if (returnUrl) {
                returnUrl = decodeURIComponent(returnUrl);
            }

            // Show URL info if we have panel or return URL
            if (panelId || returnUrl) {
                const urlInfo = document.getElementById('urlInfo');
                if (urlInfo) {
                    urlInfo.style.display = 'block';
                    let infoText = '';
                    if (panelId) infoText += `Panel ID: ${panelId}<br>`;
                    if (returnUrl) infoText += '‚úì Connected to Survey';
                    urlInfo.innerHTML = infoText;
                }
            }

            // Set up event listeners
            setupEventListeners();

            // Auto-start if requested
            if (autoStartParam === 'true') {
                playerName = 'Participant';
                elements.playerNameInput().value = playerName;
                setTimeout(() => joinGame(), 1000);
            }
            
            console.log('Game initialized, showing entry form');
        }

        function setupEventListeners() {
            // Join game button
            const joinBtn = elements.joinGameBtn();
            if (joinBtn) {
                joinBtn.addEventListener('click', handleJoinGame);
            }

            // Enter key on name input
            const nameInput = elements.playerNameInput();
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleJoinGame();
                    }
                });
            }

            // Submit choice button
            const submitBtn = elements.submitChoiceBtn();
            if (submitBtn) {
                submitBtn.addEventListener('click', submitConjointChoice);
            }

            // Return button
            const returnBtn = elements.returnBtn();
            if (returnBtn) {
                returnBtn.addEventListener('click', returnToSource);
            }
        }

        function handleJoinGame() {
            const nameInput = elements.playerNameInput();
            if (!nameInput) return;
            
            const name = nameInput.value.trim();
            if (!name) {
                showError('Please enter your name');
                return;
            }
            
            playerName = name;
            joinGame();
        }

        function showError(message) {
            const errorEl = elements.errorMessage();
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 3000);
            }
        }

        function showView(viewName) {
            console.log('Showing view:', viewName);
            
            // Hide all views
            const views = ['entryView', 'lobbyView', 'conjointView', 'buildingView', 'resultsView'];
            views.forEach(view => {
                const el = document.getElementById(view);
                if (el) {
                    el.classList.add('hidden');
                }
            });

            // Show the requested view
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                console.log('API call:', endpoint, options);
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateConnectionStatus('connected');
                const data = await response.json();
                console.log('API response:', data);
                return data;
            } catch (error) {
                console.error('API Error:', error);
                updateConnectionStatus('disconnected');
                throw error;
            }
        }

        function updateConnectionStatus(status) {
            connectionStatus = status;
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.className = `connection-status ${status}`;
                statusEl.textContent = status === 'connected' ? 'üü¢ Connected' : 'üî¥ Disconnected';
            }
        }

        // Game functions
        async function joinGame() {
            console.log('Attempting to join game with name:', playerName);
            
            if (!playerName.trim()) {
                showError('Please enter your name');
                return;
            }
            
            try {
                // Disable join button
                const joinBtn = elements.joinGameBtn();
                if (joinBtn) {
                    joinBtn.disabled = true;
                    joinBtn.textContent = 'Joining...';
                }
                
                const result = await apiCall('/game/join', {
                    method: 'POST',
                    body: JSON.stringify({
                        playerName: playerName.trim(),
                        panelId: panelId
                    })
                });
                
                gameId = result.gameId;
                playerId = result.playerId;
                gameState = 'lobby';
                
                console.log('Successfully joined game:', gameId, 'as player:', playerId);
                
                showView('lobbyView');
                startGameUpdates();
                
            } catch (error) {
                console.error('Failed to join game:', error);
                showError('Failed to join game. Please try again.');
                
                // Re-enable join button
                const joinBtn = elements.joinGameBtn();
                if (joinBtn) {
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'Join Game';
                }
            }
        }

        function startGameUpdates() {
            console.log('Starting game updates...');
            
            updateInterval = setInterval(async () => {
                if (!gameId) return;
                
                try {
                    const status = await apiCall(`/game/status?gameId=${gameId}`);
                    const previousStage = gameData?.stage;
                    
                    gameData = status;
                    currentPlayer = status.players.find(p => p.id === playerId);
                    
                    console.log('Game status update:', status.stage, 'Previous:', previousStage);
                    
                    // Update game state based on server state
                    if (status.stage === 'lobby' && gameState !== 'lobby') {
                        gameState = 'lobby';
                        showView('lobbyView');
                        updateLobbyView();
                    } else if (status.stage === 'conjoint' && gameState !== 'conjoint') {
                        gameState = 'conjoint';
                        showView('conjointView');
                        updateConjointView();
                    } else if (status.stage === 'building' && gameState !== 'building') {
                        gameState = 'building';
                        showView('buildingView');
                        updateBuildingView();
                    } else if (status.stage === 'completed' && gameState !== 'results') {
                        gameState = 'results';
                        showView('resultsView');
                        updateResultsView();
                        clearInterval(updateInterval);
                        return;
                    }
                    
                    // Update current view
                    if (gameState === 'lobby') updateLobbyView();
                    else if (gameState === 'conjoint') updateConjointView();
                    else if (gameState === 'building') updateBuildingView();
                    
                } catch (error) {
                    console.error('Failed to update game status:', error);
                }
            }, gameState === 'lobby' ? 1000 : 2000);
        }

        function updateLobbyView() {
            if (!gameData) return;
            
            const lobbyTimer = Math.max(0, gameData.lobby_timer || 0);
            const players = gameData.players || [];
            
            // Update status
            const statusEl = document.getElementById('lobbyStatus');
            if (statusEl) {
                statusEl.innerHTML = gameData.stage === 'conjoint' 
                    ? 'üöÄ Starting now!' 
                    : `üïê Starting in ${lobbyTimer} seconds<br><small>Waiting for more players... (${players.filter(p => !p.is_bot).length}/4 real players)</small>`;
            }
            
            // Update progress bar
            const progressBar = document.querySelector('#lobbyProgress .progress-bar');
            if (progressBar) {
                const progress = ((20 - lobbyTimer) / 20) * 100;
                progressBar.style.width = `${Math.max(0, progress)}%`;
            }
            
            // Update players list
            const playersContainer = document.getElementById('playersContainer');
            if (playersContainer) {
                playersContainer.innerHTML = players.map(player => `
                    <div class="player-item ${player.id === playerId ? 'current-user' : ''}">
                        <div style="font-size: 2em; margin-bottom: 10px;">
                            ${player.is_bot ? 'ü§ñ' : player.id === playerId ? 'üë§ (You)' : 'üë§'}
                        </div>
                        <div style="font-weight: bold;">${player.name}</div>
                        <div style="font-size: 0.8em; color: #666;">
                            ${player.is_bot ? 'Bot' : 'Real Player'}
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateConjointView() {
            if (!gameData) return;
            
            // Update timer
            const timerEl = document.getElementById('conjointTimer');
            if (timerEl) {
                timerEl.textContent = `Time remaining: ${gameData.round_timer || 30}s`;
            }
            
            // Update product options
            const optionsContainer = document.getElementById('productOptions');
            if (optionsContainer && gameData.product_options) {
                const hasSubmitted = currentPlayer?.conjoint_choice !== null;
                
                optionsContainer.innerHTML = gameData.product_options.map((option, index) => `
                    <div class="product-option ${selectedOption === index ? 'selected' : ''}" 
                         onclick="${hasSubmitted ? '' : `selectOption(${index})`}"
                         style="${hasSubmitted ? 'opacity: 0.7; cursor: not-allowed;' : ''}">
                        <h3>${option.name}</h3>
                        <ul class="feature-list">
                            ${option.features.map(feature => `<li>${feature}</li>`).join('')}
                        </ul>
                        ${hasSubmitted && currentPlayer.conjoint_choice === index ? 
                            '<div style="margin-top: 10px; color: #28a745; font-weight: bold;">‚úì Your Choice</div>' : ''}
                    </div>
                `).join('');
            }
            
            // Update submit button
            const submitBtn = elements.submitChoiceBtn();
            if (submitBtn) {
                const hasSubmitted = currentPlayer?.conjoint_choice !== null;
                submitBtn.disabled = selectedOption === null || hasSubmitted;
                submitBtn.textContent = hasSubmitted ? 'Choice Submitted' : 'Submit Choice';
            }
        }

        function updateBuildingView() {
            if (!gameData) return;
            
            // Update timer
            const timerEl = document.getElementById('buildingTimer');
            if (timerEl) {
                timerEl.textContent = `Time remaining: ${gameData.round_timer || 60}s`;
            }
            
            // Update available features
            const featuresGrid = document.getElementById('featuresGrid');
            if (featuresGrid && gameData.available_features) {
                featuresGrid.innerHTML = gameData.available_features.map(feature => `
                    <div class="feature-tile" draggable="true" 
                         ondragstart="handleDragStart(event, '${feature}')">
                        ${feature}
                    </div>
                `).join('');
            }
            
            // Update player board
            const playerBoard = document.getElementById('playerBoard');
            if (playerBoard && currentPlayer) {
                const board = currentPlayer.board || [];
                playerBoard.innerHTML = '';
                
                for (let i = 0; i < 4; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'board-slot';
                    slot.ondrop = (e) => handleDrop(e, i);
                    slot.ondragover = (e) => e.preventDefault();
                    
                    if (board[i]) {
                        slot.classList.add('filled');
                        slot.textContent = board[i];
                    } else {
                        slot.textContent = `Slot ${i + 1}`;
                    }
                    
                    playerBoard.appendChild(slot);
                }
            }
            
            // Update other players
            const otherPlayersContainer = document.getElementById('otherPlayersContainer');
            if (otherPlayersContainer && gameData.players) {
                const otherPlayers = gameData.players.filter(p => p.id !== playerId);
                
                otherPlayersContainer.innerHTML = otherPlayers.map(player => `
                    <div class="other-player ${player.board && player.board.length > 0 ? 'has-features' : ''}">
                        <h4>${player.name} ${player.is_bot ? 'ü§ñ' : ''}</h4>
                        <div class="other-player-features">
                            ${Array.from({length: 4}, (_, i) => `
                                <div class="feature-slot ${player.board && player.board[i] ? 'filled' : 'empty'}"
                                     ${player.board && player.board[i] ? 
                                       `draggable="true" ondragstart="handleDragStart(event, '${player.board[i]}', '${player.id}')"` : ''}>
                                    ${player.board && player.board[i] ? player.board[i] : 'Empty'}
                                </div>
                            `).join('')}
                        </div>
                        ${player.board && player.board.length > 0 ? 
                            '<div class="steal-hint">Click and drag features to steal them!</div>' : ''}
                    </div>
                `).join('');
            }
        }

        function updateResultsView() {
            if (!gameData) return;
            
            // Create leaderboard
            const leaderboardContainer = document.getElementById('leaderboardContainer');
            if (leaderboardContainer && gameData.players) {
                const sortedPlayers = [...gameData.players].sort((a, b) => (b.score || 0) - (a.score || 0));
                
                leaderboardContainer.innerHTML = sortedPlayers.map((player, index) => {
                    let positionClass = '';
                    if (index === 0) positionClass = 'winner';
                    else if (index === 1) positionClass = 'second';
                    else if (index === 2) positionClass = 'third';
                    
                    const rating = getOverallRating(player);
                    
                    return `
                        <div class="leaderboard-item ${positionClass} ${player.id === playerId ? 'current-user' : ''}">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1em;">
                                    ${index + 1}. ${player.name} ${player.is_bot ? 'ü§ñ' : ''}
                                    ${player.id === playerId ? ' (You)' : ''}
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    Features: ${player.board ? player.board.join(', ') : 'None'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                                    ${player.score || 0} pts
                                </div>
                                ${renderStars(rating)}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function selectOption(optionIndex) {
            if (currentPlayer?.conjoint_choice !== null) return; // Already submitted
            
            console.log('Selected option:', optionIndex);
            
            // Update UI
            document.querySelectorAll('.product-option').forEach(el => 
                el.classList.remove('selected'));
            
            const optionElements = document.querySelectorAll('.product-option');
            if (optionElements[optionIndex]) {
                optionElements[optionIndex].classList.add('selected');
            }
            
            selectedOption = optionIndex;
            
            // Enable submit button
            const submitBtn = elements.submitChoiceBtn();
            if (submitBtn) {
                submitBtn.disabled = false;
            }
        }

        async function submitConjointChoice() {
            if (selectedOption === null || currentPlayer?.conjoint_choice !== null) return;
            
            console.log('Submitting conjoint choice:', selectedOption);
            
            try {
                const submitBtn = elements.submitChoiceBtn();
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                }
                
                await apiCall('/game/conjoint', {
                    method: 'POST',
                    body: JSON.stringify({
                        gameId,
                        playerId,
                        choice: selectedOption
                    })
                });
                
                // Update local state
                if (currentPlayer) {
                    currentPlayer.conjoint_choice = selectedOption;
                }
                
                console.log('Conjoint choice submitted successfully');
                updateConjointView(); // Update UI to show submitted state
                
            } catch (error) {
                console.error('Failed to submit conjoint choice:', error);
                showError('Failed to submit choice. Please try again.');
                
                const submitBtn = elements.submitChoiceBtn();
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Choice';
                }
            }
        }

        async function addFeatureToBoard(feature, slotIndex = null) {
            if (!gameId || !playerId || gameState !== 'building') return;
            
            console.log('Adding feature to board:', feature, 'slot:', slotIndex);
            
            try {
                await apiCall('/game/build', {
                    method: 'POST',
                    body: JSON.stringify({
                        gameId,
                        playerId,
                        action: 'add',
                        feature,
                        slotIndex
                    })
                });
                
                console.log('Feature added successfully');
            } catch (error) {
                console.error('Failed to add feature:', error);
                showNotification('Failed to add feature. Please try again.', 'error');
            }
        }

        async function stealFeature(sourcePlayerId, feature, targetSlot) {
            if (!gameId || !playerId || gameState !== 'building') return;
            
            console.log('Stealing feature:', feature, 'from:', sourcePlayerId, 'to slot:', targetSlot);
            
            try {
                await apiCall('/game/build', {
                    method: 'POST',
                    body: JSON.stringify({
                        gameId,
                        playerId,
                        action: 'steal',
                        feature,
                        sourcePlayerId,
                        slotIndex: targetSlot
                    })
                });
                
                console.log('Feature stolen successfully');
            } catch (error) {
                console.error('Failed to steal feature:', error);
                showNotification('Failed to steal feature. Please try again.', 'error');
            }
        }

        function handleDragStart(event, feature, sourcePlayerId = null) {
            console.log('Drag start:', feature, 'from player:', sourcePlayerId);
            
            event.dataTransfer.setData('text/plain', feature);
            if (sourcePlayerId) {
                event.dataTransfer.setData('source-player', sourcePlayerId);
            }
            event.dataTransfer.effectAllowed = 'move';
            
            event.target.classList.add('dragging');
            
            // Highlight valid drop targets
            const playerBoardSlots = document.querySelectorAll('#playerBoard .board-slot:not(.filled)');
            playerBoardSlots.forEach(slot => {
                slot.classList.add(sourcePlayerId ? 'steal-target' : 'can-drop');
            });
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            
            // Remove highlighting from all board slots
            const allBoardSlots = document.querySelectorAll('.board-slot');
            allBoardSlots.forEach(slot => {
                slot.classList.remove('can-drop', 'steal-target');
            });
        }

        function handleDrop(event, slotIndex) {
            event.preventDefault();
            const feature = event.dataTransfer.getData('text/plain');
            const sourcePlayerId = event.dataTransfer.getData('source-player');
            
            console.log('Drop:', feature, 'to slot:', slotIndex, 'from player:', sourcePlayerId);
            
            if (sourcePlayerId) {
                stealFeature(sourcePlayerId, feature, slotIndex);
            } else {
                addFeatureToBoard(feature, slotIndex);
            }
            
            // Remove highlighting
            event.target.classList.remove('can-drop', 'steal-target');
        }

        function showNotification(message, type = 'success') {
            console.log('Notification:', message, type);
            
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#dc3545' : '#28a745';
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1001;
                font-weight: bold;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }

        function getFeatureRating(feature) {
            if (!gameData?.feature_stats?.[feature]) return 1;
            
            const stats = gameData.feature_stats[feature];
            const totalScore = stats.conjoint_selections * 10 + stats.build_selections * 5;
            
            if (totalScore >= 40) return 5;
            if (totalScore >= 30) return 4;
            if (totalScore >= 20) return 3;
            if (totalScore >= 10) return 2;
            return 1;
        }

        function getOverallRating(player) {
            if (!player.board || player.board.length === 0) return 1;
            
            const avgRating = player.board.reduce((sum, feature) => {
                return sum + getFeatureRating(feature);
            }, 0) / player.board.length;
            
            return Math.round(avgRating);
        }

        function renderStars(rating, maxStars = 5) {
            let stars = '';
            for (let i = 1; i <= maxStars; i++) {
                stars += `<span class="star ${i <= rating ? '' : 'empty'}">‚òÖ</span>`;
            }
            return `<div class="star-rating">${stars}</div>`;
        }

        function returnToSource() {
            console.log('Returning to source, returnUrl:', returnUrl);
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            if (returnUrl) {
                try {
                    const url = new URL(returnUrl);
                    if (panelId) url.searchParams.set('panel', panelId);
                    url.searchParams.set('completed', 'true');
                    url.searchParams.set('score', currentPlayer?.score || 0);
                    
                    console.log('Redirecting to:', url.toString());
                    window.location.href = url.toString();
                } catch (error) {
                    console.error('Error parsing return URL:', error);
                    alert(`Game Complete! Final Score: ${currentPlayer?.score || 0}`);
                    window.location.reload();
                }
            } else {
                alert(`Game Complete! Final Score: ${currentPlayer?.score || 0}`);
                window.location.reload();
            }
        }

        // Add drag event listeners globally
        document.addEventListener('dragend', handleDragEnd);
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            updateConnectionStatus('disconnected');
        });

        // Test function for debugging
        window.testGame = function() {
            console.log('Game state:', {
                gameState,
                gameId,
                playerId,
                playerName,
                gameData,
                currentPlayer
            });
        };
    </script>
</body>
</html>